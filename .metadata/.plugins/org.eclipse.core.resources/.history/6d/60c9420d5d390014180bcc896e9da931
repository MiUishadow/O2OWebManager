package com.o2oweb.action;

import net.sf.json.JSONObject;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Service;

import com.o2oweb.dao.UserDao;
import com.o2oweb.entity.User;
import com.o2oweb.util.BaseAction;
import com.opensymphony.xwork2.ActionContext;


@Scope("request")
@Service("userReg")
public class UserReg extends BaseAction {

	private static final String RESULTTAG = "RegResult";
	private static final String INFO = "info";
	private static final String CALLBACKURL = "url";
	private static final String URLSTRING = "successURL";
	
	
	private String email;
	private String phone;
	private String validCode;
	private String password;
	private String pwd;
	@Autowired
	private UserDao userdao;
	




	public String getPhone() {
		return phone;
	}



	public String getValidCode() {
		return validCode;
	}




	public String getEmail() {
		return email;
	}



	public void setEmail(String email) {
		this.email = email;
	}



	public void setPhone(String phone) {
		this.phone = phone;
	}



	public void setValidCode(String validCode) {
		this.validCode = validCode;
	}

	


	public String getPassword() {
		return password;
	}



	public String getPwd() {
		return pwd;
	}



	public void setPassword(String password) {
		this.password = password;
	}



	public void setPwd(String pwd) {
		this.pwd = pwd;
	}



	public String onRegByMail(){
		JSONObject obj = new JSONObject();
		String generCode = (String) ActionContext.getContext().getSession().get("validCode");
		if(validCode == null || !validCode.equals(generCode)){
			obj.accumulate(RESULTTAG, false);
			obj.accumulate(INFO, "验证码错误");
			obj.accumulate(CALLBACKURL, "ValidfalesURL");
			writeResponse(obj);
			return "validCodeError";
		}
		User user = null;
		user = userdao.getUser(email, 'e');
		if(user != null){
			obj.accumulate(RESULTTAG, false);
			obj.accumulate(INFO, "邮箱已经存在");
			obj.accumulate(CALLBACKURL, "falesURL");
		}else if(!password.equals(pwd)){
			obj.accumulate(RESULTTAG, false);
			obj.accumulate(INFO, "两次输入的密码不一致");
			obj.accumulate(CALLBACKURL, "falesURL");
		}else {
			System.out.println("email="+email+"password="+password);
			user = new User(email,password,email,"0","0",0);
			userdao.save(user);
			ActionContext.getContext().getSession().put("user", user);
			obj.accumulate(RESULTTAG, true);
			obj.accumulate(INFO, "注册成功");
			obj.accumulate(CALLBACKURL, URLSTRING);
		}
		writeResponse(obj);
		return "success";
	}
}
