package com.o2oweb.action;

import net.sf.json.JSONObject;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Service;

import com.o2oweb.dao.UserDao;
import com.o2oweb.entity.User;
import com.o2oweb.util.BaseAction;
import com.o2oweb.util.PasswordUtil;
import com.opensymphony.xwork2.ActionContext;

@Scope("request")
@Service("userLogin")
public class UserLogin extends BaseAction{

	private String user_name;
	private String user_password;
	
	private String remember;
	
	private static final String RESULTTAG = "loginResult";
	private static final String INFO = "info";
	private static final String CALLBACKURL = "url";
	private static final String URLSTRING = "successURL";
	@Autowired
	private UserDao userdao;
	
	
	public String getUser_name() {
		return user_name;
	}
	public String getUser_password() {
		return user_password;
	}
	public void setUser_name(String user_name) {
		this.user_name = user_name;
	}
	public void setUser_password(String user_password) {
		this.user_password = user_password;
	}
	
	public String getRemember() {
		return remember;
	}
	public void setRemember(String remember) {
		this.remember = remember;
	}
	public String onLogin(){
		if(remember != null){
			System.out.println("remembered");
		}
		
		//调试用
		System.out.println(ActionContext.getContext().getSession().get("block"));
		
		
		JSONObject obj = new JSONObject();
		User user = userdao.getUser(user_name, 'u');
		if(user == null){
			obj.accumulate(RESULTTAG, false);
			obj.accumulate(INFO, "用户名不存在");
			obj.accumulate(CALLBACKURL, "");
		}else if(!passwordEquals(user_password,user.getPassword())){
			obj.accumulate(RESULTTAG, false);
			obj.accumulate(INFO, "密码输入错误");
			obj.accumulate(CALLBACKURL, "");
		}else {
			obj.accumulate(RESULTTAG, true);
			obj.accumulate(INFO, "验证通过");
			obj.accumulate(CALLBACKURL, URLSTRING);
			ActionContext.getContext().getSession().put("user", user);
		}
		if(remember != null){
			
		}
		writeResponse(obj);
		return "success";
	}
	private boolean passwordEquals(String user_password2, String password) {
		String codePassword = PasswordUtil.toMd5(user_password2);
		return password.equals(codePassword);
	}
}
